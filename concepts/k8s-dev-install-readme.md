# Kubernetes Installation for Docker Desktop & Dashboard

## Kubernetes version
```cmd
C:\Users\abhinab>kubectl version
Client Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.5", GitCommit:"0e9fcb426b100a2aea5ed5c25b3d8cfbb01a8acf", GitTreeState:"clean", BuildDate:
"2019-08-05T09:21:30Z", GoVersion:"go1.12.5", Compiler:"gc", Platform:"windows/amd64"}

Server Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.5", GitCommit:"0e9fcb426b100a2aea5ed5c25b3d8cfbb01a8acf", GitTreeState:"clean", BuildDate:
"2019-08-05T09:13:08Z", GoVersion:"go1.12.5", Compiler:"gc", Platform:"linux/amd64"}
```

## Installing kubernetes single node cluster for Docker Desktop
* Intalling docker for windows - https://docs.docker.com/docker-for-windows/install/
* Installing kubernetes single node cluster for Docker Desktop - https://docs.docker.com/docker-for-windows/kubernetes/

```cmd
kubectl get nodes
NAME             STATUS   ROLES    AGE    VERSION
docker-desktop   Ready    master   164m   v1.14.3

kubectl get services
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   4h12m

kubectl get namespace
NAME                   STATUS   AGE
default                Active   4h12m
docker                 Active   4h10m
kube-node-lease        Active   4h12m
kube-public            Active   4h12m
kube-system            Active   4h12m
```

## Configure kubernetes dashboard
```cmd 
# Proxy requirements for kubectl
set http_proxy=http://<user-id>:<password>@<proxy>:<port>
set https_proxy=http://<user-id>:<password>@<proxy>:<port>
set no_proxy=*.domain.com,*.docker.internal

kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml --insecure-skip-tls-verify=true
namespace/kubernetes-dashboard created
serviceaccount/kubernetes-dashboard created
service/kubernetes-dashboard created
secret/kubernetes-dashboard-certs created
secret/kubernetes-dashboard-csrf created
secret/kubernetes-dashboard-key-holder created
configmap/kubernetes-dashboard-settings created
role.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
deployment.apps/kubernetes-dashboard created
service/dashboard-metrics-scraper created
deployment.apps/dashboard-metrics-scraper created

kubectl get namespace
NAME                   STATUS   AGE
default                Active   4h12m
docker                 Active   4h10m
kube-node-lease        Active   4h12m
kube-public            Active   4h12m
kube-system            Active   4h12m
kubernetes-dashboard   Active   93s

# Access Dashboard using the kubectl command
kubectl proxy
Starting to serve on 127.0.0.1:8001

# To run it on a custom port other that 8001 
kubectl proxy --port=80
```

Kubectl will make dashboard available at 
http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/

Login by fetching the token using the below command
```cmd
kubectl -n kube-system describe secret default
```

## Deploy an app to the kubernetes cluster

```cmd
# create namespace
kubectl create namespace abs

# deploy to local k8s node cluster
docker stack deploy --namespace abs --orchestrator kubernetes --compose-file D:\Abhinab\k8s\wordsmith-demo.yaml abs-stack
```

wordsmith-demo.yaml
```yaml
version: '3.3'

services:
  web:
    image: dockersamples/k8s-wordsmith-web
    ports:
     - "80:80"

  words:
    image: dockersamples/k8s-wordsmith-api
    deploy:
      replicas: 5
      endpoint_mode: dnsrr
      resources:
        limits:
          memory: 50M
        reservations:
          memory: 50M

  db:
    image: dockersamples/k8s-wordsmith-db
```
Browse to http://localhost:80 to see the site. Each time you refresh the page, you'll see a different sentence generated by the API calls.

To view the list of pods and services on the namespace, run the following commands
```cmd
kubectl get pods -n abs
kubectl get svc -n abs
```

## Verbosity with kubectl
```cmd
kubectl get namespace --v=99
```

## Connect to Kubernetes remote cluster from cli

```cmd
# Get the current kube config settings
kubectl config view
# Help on config
kubectl config -h

# Configure cluster in kube config
kubectl config set-cluster <cluster-name> --server=<remote-cluster:port> --insecure-skip-tls-verify=true

# create user in kube config
kubectl config set-credentials <user/svcacct-name> --token=<jwt_token>

# Create context in kube config
kubectl config set-context <context-name> --cluster=<cluster-name> --user=<user/svcacct-name>

# Switch context
kubectl config use-context <context-name>

# check access
kubectl -n <namespace> auth can-i create pod
```